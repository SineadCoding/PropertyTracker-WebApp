#:import rgba kivy.utils.get_color_from_hex

ScreenManager:
    PropertyListScreen:
    # SoldScreen:  # SoldScreen logic present but commented out

<PropertyListScreen>:
    name: "property_list"
    FloatLayout:
        BoxLayout:
            orientation: "vertical"
            padding: "0dp"
            spacing: "0dp"
            canvas.before:
                Color:
                    rgba: rgba("#F5F6FA")
                Rectangle:
                    pos: self.pos
                    size: self.size

            # --- Top Bar: Filter & Refresh ---
            BoxLayout:
                orientation: "horizontal"
                size_hint_y: None
                height: "36dp"
                spacing: "2dp"
                Button:
                    id: filter_toggle_btn
                    text: "Filter"
                    background_color: 0,0,0,0
                    color: rgba("#222F3E")
                    font_size: "13sp"
                    bold: True
                    size_hint_x: 0.6
                    on_release: root.toggle_filter_section()
                Button:
                    text: "Refresh"
                    background_color: rgba("#10AC84")
                    color: rgba("#FFFFFF")
                    font_size: "12sp"
                    bold: True
                    size_hint_x: 0.4
                    on_release: root.on_refresh()
                    canvas.before:
                        Color:
                            rgba: rgba("#10AC84")
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [8]

            # --- Sort By Dropdown BELOW Refresh ---
            BoxLayout:
                orientation: "horizontal"
                size_hint_y: None
                height: "36dp"
                spacing: "2dp"
                Widget:
                    size_hint_x: 0.6
                Spinner:
                    id: sort_spinner
                    text: root.sort_option if root.sort_option else "Sort By"
                    values: ["No Sort", "Price High to Low", "Price Low to High", "A-Z", "Z-A"]
                    size_hint_x: 0.4
                    font_size: "12sp"
                    background_color: rgba("#FFFFFF")
                    color: rgba("#222F3E")
                    border: (1, 1, 1, 1)
                    canvas.before:
                        Color:
                            rgba: rgba("#FFFFFF")
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [5]
                        Color:
                            rgba: rgba("#10AC84")
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 5)
                            width: 1
                    on_text: root.on_sort_option(self, self.text)

            Label:
                text: "Current Listings"
                font_size: "20sp"
                color: rgba("#222F3E")
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: "26dp"

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: (80 if root.filter_section_open else 0)
                opacity: 1 if root.filter_section_open else 0
                BoxLayout:
                    orientation: "horizontal"
                    spacing: "6dp"
                    padding: [6, 6]
                    Label:
                        text: "Min: R{:,}".format(int(root.filter_min_price))
                        size_hint_x: 0.2
                        font_size: "13sp"
                        color: rgba("#222F3E")
                    Slider:
                        id: min_price_slider
                        min: 10000
                        max: 8000000
                        value: root.filter_min_price
                        step: 10000
                        size_hint_x: 0.3
                        on_value: root.on_min_slider_value(self.value)
                    Label:
                        text: "Max: R{:,}".format(int(root.filter_max_price))
                        size_hint_x: 0.2
                        font_size: "13sp"
                        color: rgba("#222F3E")
                    Slider:
                        id: max_price_slider
                        min: 10000
                        max: 8000000
                        value: root.filter_max_price
                        step: 10000
                        size_hint_x: 0.3
                        on_value: root.on_max_slider_value(self.value)
                    Button:
                        text: "Apply"
                        size_hint_x: 0.12
                        background_color: rgba("#10AC84")
                        color: rgba("#FFFFFF")
                        font_size: "12sp"
                        bold: True
                        border: (0, 0, 0, 0)
                        on_release: root.apply_filter()
                    Button:
                        text: "Undo"
                        size_hint_x: 0.12
                        background_color: rgba("#222F3E")
                        color: rgba("#FFFFFF")
                        font_size: "12sp"
                        bold: True
                        border: (0, 0, 0, 0)
                        on_release: root.undo_filters()

            ScrollView:
                GridLayout:
                    id: property_list
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: "8dp"
                    padding: "4dp"

            BoxLayout:
                orientation: "horizontal"
                size_hint_y: None
                height: "36dp"
                spacing: "0dp"
                canvas.before:
                    Color:
                        rgba: rgba("#FFFFFF")
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Button:
                    text: "Current Listings"
                    background_color: rgba("#10AC84")
                    color: rgba("#FFFFFF")
                    font_size: "13sp"
                    bold: True
                    size_hint_x: 1.0
                    on_release: app.root.current = "property_list"
                # Button:
                #     text: "Sold"
                #     background_color: rgba("#222F3E")
                #     color: rgba("#FFFFFF")
                #     font_size: "13sp"
                #     bold: True
                #     on_release: app.root.current = "sold"

<PropertyCard>:
    orientation: "vertical"
    size_hint_y: None
    height: "140dp"
    padding: "10dp"
    spacing: "6dp"
    canvas.before:
        Color:
            rgba: rgba("#FFFFFF")
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        Color:
            rgba: rgba("#10AC84")
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 12)
            width: 2

    Label:
        id: location
        text: root.location
        halign: 'left'
        valign: 'top'
        text_size: self.width, None
        font_size: "16sp"
        color: rgba("#222F3E")
        bold: True

    Label:
        id: price
        text: f"{root.price}   [color=#576574]{root.gbp_price}[/color]"
        markup: True
        halign: 'left'
        valign: 'top'
        text_size: self.width, None
        font_size: "14sp"
        color: rgba("#576574")

    Label:
        id: agency
        text: root.agency
        halign: 'left'
        valign: 'top'
        text_size: self.width, None
        font_size: "13sp"
        color: rgba("#8395A7")

    Label:
        text: "âš  Source currently blocked"
        font_size: "12sp"
        color: rgba("#EE5253")
        size_hint_y: None
        height: "18dp"
        halign: "left"
        valign: "middle"
        text_size: self.width, None
        opacity: 1 if app.blocked_sources and root.source in app.blocked_sources else 0

    Button:
        id: link
        text: "View Listing"
        size_hint_y: None
        height: "32dp"
        background_color: rgba("#222F3E")
        color: rgba("#FFFFFF")
        font_size: "13sp"
        on_release: app.open_url(root.link)
        canvas.before:
            Color:
                rgba: rgba("#222F3E")
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [8]

# --- SoldScreen logic below, fully commented out ---
# <SoldScreen>:
#     name: "sold"
#     BoxLayout:
#         orientation: "vertical"
#         padding: "0dp"
#         spacing: "0dp"
#         canvas.before:
#             Color:
#                 rgba: rgba("#F5F6FA")
#             Rectangle:
#                 pos: self.pos
#                 size: self.size
#
#         # --- Top Bar: Filter & Refresh ---
#         BoxLayout:
#             orientation: "horizontal"
#             size_hint_y: None
#             height: "36dp"
#             spacing: "2dp"
#             Button:
#                 id: sold_filter_toggle_btn
#                 text: "Filter"
#                 background_color: 0,0,0,0
#                 color: rgba("#222F3E")
#                 font_size: "13sp"
#                 bold: True
#                 size_hint_x: 0.6
#                 on_release: root.toggle_filter_section()
#             Button:
#                 text: "Refresh"
#                 background_color: rgba("#10AC84")
#                 color: rgba("#FFFFFF")
#                 font_size: "12sp"
#                 bold: True
#                 size_hint_x: 0.4
#                 on_release: root.on_refresh()
#                 canvas.before:
#                     Color:
#                         rgba: rgba("#10AC84")
#                     RoundedRectangle:
#                         pos: self.pos
#                         size: self.size
#                         radius: [8]
#
#         # --- Sort By Dropdown BELOW Refresh ---
#         BoxLayout:
#             orientation: "horizontal"
#             size_hint_y: None
#             height: "36dp"
#             spacing: "2dp"
#             Widget:
#                 size_hint_x: 0.6
#             Spinner:
#                 id: sold_sort_spinner
#                 text: root.sort_option if root.sort_option else "Sort By"
#                 values: ["No Sort", "Price High to Low", "Price Low to High", "A-Z", "Z-A"]
#                 size_hint_x: 0.4
#                 font_size: "12sp"
#                 background_color: rgba("#FFFFFF")
#                 color: rgba("#222F3E")
#                 border: (1, 1, 1, 1)
#                 canvas.before:
#                     Color:
#                         rgba: rgba("#FFFFFF")
#                     RoundedRectangle:
#                         pos: self.pos
#                         size: self.size
#                         radius: [5]
#                     Color:
#                         rgba: rgba("#10AC84")
#                     Line:
#                         rounded_rectangle: (self.x, self.y, self.width, self.height, 5)
#                         width: 1
#                 on_text: root.on_sort_option(self, self.text)
#
#         Label:
#             text: "Sold Properties"
#             font_size: "20sp"
#             color: rgba("#222F3E")
#             halign: "center"
#             valign: "middle"
#             size_hint_y: None
#             height: "26dp"
#
#         BoxLayout:
#             orientation: "vertical"
#             size_hint_y: None
#             height: (80 if root.filter_section_open else 0)
#             opacity: 1 if root.filter_section_open else 0
#             BoxLayout:
#                 orientation: "horizontal"
#                 spacing: "6dp"
#                 padding: [6, 6]
#                 Label:
#                     text: "Min: R{:,}".format(int(root.filter_min_price))
#                     size_hint_x: 0.2
#                     font_size: "13sp"
#                     color: rgba("#222F3E")
#                 Slider:
#                     id: sold_min_price_slider
#                     min: 10000
#                     max: 8000000
#                     value: root.filter_min_price
#                     step: 10000
#                     size_hint_x: 0.3
#                     on_value: root.on_min_slider_value(self.value)
#                 Label:
#                     text: "Max: R{:,}".format(int(root.filter_max_price))
#                     size_hint_x: 0.2
#                     font_size: "13sp"
#                     color: rgba("#222F3E")
#                 Slider:
#                     id: sold_max_price_slider
#                     min: 10000
#                     max: 8000000
#                     value: root.filter_max_price
#                     step: 10000
#                     size_hint_x: 0.3
#                     on_value: root.on_max_slider_value(self.value)
#                 Button:
#                     text: "Apply"
#                     size_hint_x: 0.12
#                     background_color: rgba("#10AC84")
#                     color: rgba("#FFFFFF")
#                     font_size: "12sp"
#                     bold: True
#                     border: (0, 0, 0, 0)
#                     on_release: root.apply_filter()
#                 Button:
#                     text: "Undo"
#                     size_hint_x: 0.12
#                     background_color: rgba("#222F3E")
#                     color: rgba("#FFFFFF")
#                     font_size: "12sp"
#                     bold: True
#                     border: (0, 0, 0, 0)
#                     on_release: root.undo_filters()
#
#         ScrollView:
#             GridLayout:
#                 id: sold_list
#                 cols: 1
#                 size_hint_y: None
#                 height: self.minimum_height
#                 spacing: "8dp"
#                 padding: "4dp"
#
#         BoxLayout:
#             orientation: "horizontal"
#             size_hint_y: None
#             height: "36dp"
#             spacing: "0dp"
#             canvas.before:
#                 Color:
#                     rgba: rgba("#FFFFFF")
#                 Rectangle:
#                     pos: self.pos
#                     size: self.size
#             Button:
#                 text: "Listings"
#                 background_color: rgba("#10AC84")
#                 color: rgba("#FFFFFF")
#                 font_size: "13sp"
#                 bold: True
#                 on_release: app.root.current = "property_list"
#             Button:
#                 text: "Sold"
#                 background_color: rgba("#222F3E")
#                 color: rgba("#FFFFFF")
#                 font_size: "13sp"
#                 bold: True
#                 on_release: app.root.current = "sold"